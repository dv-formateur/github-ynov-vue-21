const isOffline = false;

const projects = [
    "github-ynov-vue"
];

const names = [
    "TeofiloJ",
    "RaphaelCharre"
];

const offline_commits = [
    {
      "sha": "84de17b89748fc995cbcfb4dd779400d29b648db",
      "node_id": "MDY6Q29tbWl0MTUzNjM4NzcxOjg0ZGUxN2I4OTc0OGZjOTk1Y2JjZmI0ZGQ3Nzk0MDBkMjliNjQ4ZGI=",
      "commit": {
        "author": {
          "name": "DefaultUser",
          "email": "default-user@gmail.com",
          "date": "2018-10-19T06:01:38Z"
        },
        "committer": {
          "name": "default user",
          "email": "default-user@gmail.com",
          "date": "2018-10-19T06:01:38Z"
        },
        "message": "implementation of search function",
        "tree": {
          "sha": "aeb2df1bf3d7b94de58db73135c36c3fb6de6383",
          "url": "https://api.github.com/repos/TeofiloJ/github-ynov-vue/git/trees/aeb2df1bf3d7b94de58db73135c36c3fb6de6383"
        },
        "url": "https://api.github.com/repos/TeofiloJ/github-ynov-vue/git/commits/84de17b89748fc995cbcfb4dd779400d29b648db",
        "comment_count": 0,
        "verification": {
          "verified": false,
          "reason": "unsigned",
          "signature": null,
          "payload": null
        }
      },
      "url": "https://api.github.com/repos/TeofiloJ/github-ynov-vue/commits/84de17b89748fc995cbcfb4dd779400d29b648db",
      "html_url": "https://github.com/TeofiloJ/github-ynov-vue/commit/84de17b89748fc995cbcfb4dd779400d29b648db",
      "comments_url": "https://api.github.com/repos/TeofiloJ/github-ynov-vue/commits/84de17b89748fc995cbcfb4dd779400d29b648db/comments",
      "author": {
        "login": "DefaultUser",
        "id": 34065590,
        "node_id": "MDQ6VXNlcjM0MDY1NTkw",
        "avatar_url": "https://avatars3.githubusercontent.com/u/34065590?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TeofiloJ",
        "html_url": "https://github.com/TeofiloJ",
        "followers_url": "https://api.github.com/users/TeofiloJ/followers",
        "following_url": "https://api.github.com/users/TeofiloJ/following{/other_user}",
        "gists_url": "https://api.github.com/users/TeofiloJ/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/TeofiloJ/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/TeofiloJ/subscriptions",
        "organizations_url": "https://api.github.com/users/TeofiloJ/orgs",
        "repos_url": "https://api.github.com/users/TeofiloJ/repos",
        "events_url": "https://api.github.com/users/TeofiloJ/events{/privacy}",
        "received_events_url": "https://api.github.com/users/TeofiloJ/received_events",
        "type": "User",
        "site_admin": false
      },
      "committer": {
        "login": "defaultUser",
        "id": 34065590,
        "node_id": "MDQ6VXNlcjM0MDY1NTkw",
        "avatar_url": "https://avatars3.githubusercontent.com/u/34065590?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TeofiloJ",
        "html_url": "https://github.com/TeofiloJ",
        "followers_url": "https://api.github.com/users/TeofiloJ/followers",
        "following_url": "https://api.github.com/users/TeofiloJ/following{/other_user}",
        "gists_url": "https://api.github.com/users/TeofiloJ/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/TeofiloJ/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/TeofiloJ/subscriptions",
        "organizations_url": "https://api.github.com/users/TeofiloJ/orgs",
        "repos_url": "https://api.github.com/users/TeofiloJ/repos",
        "events_url": "https://api.github.com/users/TeofiloJ/events{/privacy}",
        "received_events_url": "https://api.github.com/users/TeofiloJ/received_events",
        "type": "User",
        "site_admin": false
      },
      "parents": [
        {
          "sha": "2a246cf92431ad7736242113e7af460839b27111",
          "url": "https://api.github.com/repos/TeofiloJ/github-ynov-vue/commits/2a246cf92431ad7736242113e7af460839b27111",
          "html_url": "https://github.com/TeofiloJ/github-ynov-vue/commit/2a246cf92431ad7736242113e7af460839b27111"
        }
      ]
    }
  ];

const offline_readme = {
    "name": "README.md",
    "path": "README.md",
    "sha": "49a8044a05a9bc6fc0b3e0d0d468abb5bb315cc2",
    "size": 379,
    "url": "https://api.github.com/repos/raphaelCharre/github-ynov-vue/contents/README.md?ref=master",
    "html_url": "https://github.com/raphaelCharre/github-ynov-vue/blob/master/README.md",
    "git_url": "https://api.github.com/repos/raphaelCharre/github-ynov-vue/git/blobs/49a8044a05a9bc6fc0b3e0d0d468abb5bb315cc2",
    "download_url": "https://raw.githubusercontent.com/raphaelCharre/github-ynov-vue/master/README.md",
    "type": "file",
    "content": "IyBnaXRodWIteW5vdi12dWUNCg0KUHJvamV0IGRlIE1hdGVyZSBZbm92DQoN\nCkFmZmljaGVyIGxhIGxpc3RlIGRlcyByZXBvc2l0b3JpZXMgZ2l0aHViIGV0\nIHBvdXZvaXIgZmlsdHJlciBwYXIgdXRpbGlzYXRldXIgZXQgcGFyIHByb2pl\ndC4NCg0KRm9uY3Rpb25uYWxpdGVzIDoNCi0gRmlsdHJlciBsZXMgcmVwb3Np\ndG9yaWVzIHBhciB1dGlsaXNhdGV1cnMNCi0gRmlsdHJlciBsZXMgcmVwb3Np\ndG9yaWVzIHBhciBwcm9qZXQNCi0gQWZmaWNoZXIgbGEgbGlzdGUgZGVzIDUg\nZGVybmllcnMgY29tbWl0cw0KLSBBZmZpY2hlciBsZSBSRUFETUUgZHUgcHJv\namV0DQoNCkEgdmVuaXIgOg0KLSBGaWx0cmVyIGxlcyByZXBvc2l0b3JpZXMg\nYSBwYXJ0aXIgZCd1bmUgZGF0ZQ==\n",
    "encoding": "base64",
    "_links": {
      "self": "https://api.github.com/repos/raphaelCharre/github-ynov-vue/contents/README.md?ref=master",
      "git": "https://api.github.com/repos/raphaelCharre/github-ynov-vue/git/blobs/49a8044a05a9bc6fc0b3e0d0d468abb5bb315cc2",
      "html": "https://github.com/raphaelCharre/github-ynov-vue/blob/master/README.md"
    }
  };

var app = new Vue({
    el: '#app',
    data: {
        error: '',

        name_list : names,
        project_list : projects,

        filter_date : '',
        filter_project : '',
        filter_name : '',

        search_result : []

    } ,

    methods: {
        search : function(){
            this.search_result = [];
            var search_project = this.filter_project ? [this.filter_project] : projects;
            var search_name = this.filter_name ? [this.filter_name] : names;

            var scope = this;

            for(var project_name of search_project){
                for(var git_id of search_name){
                    if(isOffline){
                        this.error = 'Vous etes actuellement en mode hors ligne, les donnees ont ete generees.'
                        var project = {
                            author: git_id,
                            name: project_name,
                            commits : offline_commits
                        };
                        this.loadCommitsFor(scope, project);
                    }else{
                        this.requestCommitsFor(scope, project_name, git_id);
                    }
                }   
            }      
        },

        requestCommitsFor: function(scope, project_name, git_id){
            var project = {
                author: git_id,
                name: project_name,
                commits : []
            };

            jQuery.ajax({
                type: "GET",
                headers: { 
                    Accept: "application/vnd.github.cloak-preview"
                },
                url: 'https://api.github.com/repos/'+ git_id +'/'+ project_name +'/commits',
                dataType: 'json',
                success: function(data) {

                    project.commits = data;
                    scope.loadCommitsFor(scope, project);
                    
                },

                error: function(error){
                    console.log(error);
                    scope.error = error.responseText;
                }
            });
        },

        loadCommitsFor: function(scope, project){
            var min_date = new Date(scope.filter_date ? scope.filter_date : 0);

            project.commits = project.commits.filter(function(commit){
                var commit_date = new Date(commit.commit.author.date);
                return commit_date.getTime() >= min_date.getTime();
            });

            console.log(project.commits);

            if( project.commits.length > 0){
                console.log(project.commits.slice(0, 5));
                project.commits = project.commits.slice(0, 5);
                
                scope.search_result.push(project);
            }
        },

        loadRepoReadme: function(targetId, author, project_name ){
            var target = document.getElementById(targetId);

            if(target.innerText){
                return;
            }

            if(isOffline){
                target.textContent = atob(offline_readme.content);
                return;
            }
            
            jQuery.ajax({
                type: "GET",
                headers: { 
                    Accept: "application/vnd.github.cloak-preview"
                },
                dataType: 'json',
                url: 'https://api.github.com/repos/' + author + '/' + project_name + '/contents/README.md',
                success: function(data) {
                    target.textContent = atob(data.content);
                },

                error: function(error){
                    console.log(error);
                    scope.error = error.responseText;
                }
            });
        },

        resetError: function(){
            this.error = '';
        }
    }
})